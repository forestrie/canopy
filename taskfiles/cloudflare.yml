---
# Cloudflare infrastructure management using Wrangler

version: "3"

vars:
  CANOPY_ID: '{{.CANOPY_ID | default "canopy-dev-1"}}'
  R2_BUCKET_NAME_LEAVES: '{{.R2_BUCKET_NAME_LEAVES | default (print .CANOPY_ID "-leaves")}}'
  R2_BUCKET_NAME_MERKLELOGS: '{{.R2_BUCKET_NAME_MERKLELOGS | default "arbor-dev-1-logs"}}'
  BUCKET_PREFIX_LEAVES: "logs/"
  BUCKET_PREFIX_MASSIFS: "v2/merklelog/massifs/"
  BUCKET_PREFIX_CHECKPOINTS: "v2/merklelog/checkpoints/"

tasks:
  bootstrap:
    desc: Alias for bootstrap
    cmds:
      - task: validate
      - task: create
      - task: sync
      - task: status

  create:
    desc: Create all Cloudflare resources (R2 buckets, queues, KV namespaces, and event notifications)
    deps:
      - bucket:create
      - queue:create:ranger
      - queue:create:sealer
      - kv:create:all
    cmds:
      - task: r2notification:create:ranger
        vars:
          R2_BUCKET_NAME: "{{ .R2_BUCKET_NAME_LEAVES }}"
          PREFIX: "{{.BUCKET_PREFIX_LEAVES}}"

      - task: r2notification:create:sealer
        vars:
          R2_BUCKET_NAME: "{{ .R2_BUCKET_NAME_MERKLELOGS }}"
          PREFIX: "{{.BUCKET_PREFIX_MASSIFS}}"

      - task: r2notification:create:ranger-cache
        vars:
          R2_BUCKET_NAME: "{{ .R2_BUCKET_NAME_MERKLELOGS }}"
          PREFIX: "{{.BUCKET_PREFIX_CHECKPOINTS}}"
      - cmd: echo "Resources provisioned. Run 'task cloudflare:sync' to apply Wrangler bindings."

  sync:
    desc: Apply Wrangler configuration (deploy worker + ensure HTTP pull)
    deps:
      - validate
    cmds:
      - cmd: |
          cd packages/apps/canopy-api
          yes n | wrangler deploy
      - task: queue:http-enable:ranger
      - task: queue:http-enable:sealer

  destroy:
    desc: Delete all Cloudflare resources (including KV namespaces) (DESTRUCTIVE!)
    deps:
      - r2notification:delete:ranger
      - queue:delete:ranger
      - queue:delete:sealer
      - bucket:delete
      - kv:destroy:all
    cmds:
      - cmd: echo "Destruction complete"

  status:
    desc: Show status of all Cloudflare resources
    cmds:
      - task: validate
      - cmd: |
          echo "--------- :buckets: --------------------------------------------------"
          yes n | wrangler r2 bucket list
      - cmd: |
          echo "--------- :queues:  --------------------------------------------------"
          yes n | wrangler queues list
      - cmd: |
          echo "--------- :bucket notifications:  ------------------------------------"
          yes n | wrangler r2 bucket notification list "{{.R2_BUCKET_NAME_LEAVES}}" 2>/dev/null || echo "  No notifications configured"
          yes n | wrangler r2 bucket notification list "{{.R2_BUCKET_NAME_MERKLELOGS}}" 2>/dev/null || echo "  No notifications configured"

  validate:
    desc: Validate Wrangler is installed and authenticated
    cmds:
      - cmd: |
          if ! command -v wrangler &> /dev/null; then
            echo "ERROR: wrangler not found. Install with 'pnpm add -g wrangler'"
            exit 1
          fi
      - cmd: |
          if ! wrangler whoami &> /dev/null; then
            echo "ERROR: Wrangler is not authenticated. Run: wrangler login"
            exit 1
          fi

  bucket:create:
    desc: Create R2 bucket
    cmds:
      - cmd: yes n | wrangler r2 bucket create "{{.R2_BUCKET_NAME_LEAVES}}" --location weur 2>/dev/null || echo "Bucket {{.R2_BUCKET_NAME_LEAVES}} may already exist"

  bucket:delete:
    desc: Delete R2 bucket (DESTRUCTIVE! Bucket must be empty)
    cmds:
      - cmd: yes n | wrangler r2 bucket delete "{{.R2_BUCKET_NAME_LEAVES}}" 2>/dev/null || echo "Bucket {{.R2_BUCKET_NAME_LEAVES}} not found or not empty"

  kv:create:ranger-cache:
    desc: Create all well-known Cloudflare KV namespaces
    cmds:
      - task: kv:create:ranger-mmr-index
      - task: kv:create:ranger-mmr-massifs

  kv:bind:ranger-cache:
    desc: Ensure canopy-api Wrangler config is bound to the massifs KV namespace
    cmds:
      - cmd: WFILE=packages/apps/ranger-cache/wrangler.jsonc task -s cf:kv:bind:ranger-mmr-index
      - cmd: WFILE=packages/apps/ranger-cache/wrangler.jsonc task -s cf:kv:bind:ranger-mmr-massifs

  kv:list:
    desc: List {{.CANOPY_ID}}-* Cloudflare KV namespaces
    cmds:
      - cmd: |
          OUTPUT=$(yes n | wrangler kv namespace list 2>/dev/null || echo "[]")
          echo "$OUTPUT" | jq -r --arg canopy "{{.CANOPY_ID}}" '.[] | select(.title | startswith($canopy + "-")) | "\(.id)  \(.title)"'

  kv:create:*:
    desc: Create Cloudflare KV namespace
    vars:
      NAME: "{{index .MATCH 0}}"
      KV_STORE_NAME: '{{.KV_STORE_NAME | default (print .CANOPY_ID "-" .NAME)}}'
    cmds:
      - cmd: yes n | wrangler kv namespace create "{{.KV_STORE_NAME}}" || echo "KV namespace {{.KV_STORE_NAME}} may already exist"

  kv:bind:*:
    desc: Ensure Wrangler KV binding exists and is up to date for a namespace
    vars:
      NAME: "{{index .MATCH 0}}"
      KV_STORE_NAME: '{{.KV_STORE_NAME | default (print .CANOPY_ID "-" .NAME)}}'
      WFILE: "{{.WFILE}}"
    requires:
      vars: [WFILE]
    cmds:
      - cmd: |
          WFILE="{{.WFILE}}"

          OUTPUT=$(yes n | wrangler kv namespace list 2>/dev/null || echo "[]")
          NAMESPACE_ID=$(echo "$OUTPUT" | jq -r --arg name "{{.KV_STORE_NAME}}" '.[] | select(.title == $name) | .id' | head -n 1)
          if [ -z "$NAMESPACE_ID" ] || [ "$NAMESPACE_ID" = "null" ]; then
            echo "No KV namespace found with title {{.KV_STORE_NAME}}" >&2
            exit 1
          fi

          BINDING_NAME=$(printf '%s\n' "{{.NAME}}" | tr '-' '_' | tr "[:lower:]" "[:upper:]")
          TMP=$(mktemp)

          jq --arg binding "$BINDING_NAME" --arg id "$NAMESPACE_ID" '
            .kv_namespaces = (
              (.kv_namespaces // [])
              | map(select(.binding != $binding))
              + [{"binding": $binding, "id": $id}]
            )
          ' "${WFILE}" > "$TMP"
          mv "$TMP" "${WFILE}"

  kv:destroy:all:
    desc: Delete all well-known Cloudflare KV namespaces (DESTRUCTIVE!)
    cmds:
      - task: kv:destroy:massifs
      - task: kv:destroy:fenced-entries

  kv:destroy:*:
    desc: Delete Cloudflare KV namespace (DESTRUCTIVE!)
    vars:
      NAME: "{{index .MATCH 0}}"
      KV_STORE_NAME: '{{.KV_STORE_NAME | default (print .CANOPY_ID "-" .NAME)}}'
    cmds:
      - cmd: |
          OUTPUT=$(yes n | wrangler kv namespace list 2>/dev/null || echo "[]")
          NAMESPACE_ID=$(echo "$OUTPUT" | jq -r --arg name "{{.KV_STORE_NAME}}" '.[] | select(.title == $name) | .id' | head -n 1)

          if [ -z "$NAMESPACE_ID" ]; then
            echo "KV namespace {{.KV_STORE_NAME}} not found"
            exit 1
          fi
          yes n | wrangler kv namespace delete --namespace-id="$NAMESPACE_ID" || echo "KV namespace {{.KV_STORE_NAME}} not found"

  kv:id:*:
    desc: Get the id of the {{.CANOPY_ID}}-* Cloudflare KV store
    vars:
      NAME: "{{index .MATCH 0}}"
      KV_STORE_NAME: '{{.KV_STORE_NAME | default (print .CANOPY_ID "-" .NAME)}}'
    cmds:
      - cmd: |
          OUTPUT=$(yes n | wrangler kv namespace list 2>/dev/null || echo "[]")
          NAMESPACE_ID=$(echo "$OUTPUT" | jq -r --arg name "{{.KV_STORE_NAME}}" '.[] | select(.title == $name) | .id' | head -n 1)

          if [ -z "$NAMESPACE_ID" ]; then
            echo "KV namespace {{.KV_STORE_NAME}} not found" >&2
            exit 1
          fi
          echo "$NAMESPACE_ID"

  queue:create:*:
    desc: Create a Cloudflare queue and its dead-letter queue
    vars:
      NAME: "{{index .MATCH 0}}"
      QUEUE_NAME: '{{.QUEUE_NAME | default (print .CANOPY_ID "-" .NAME)}}'
      QUEUE_DLQ_NAME: '{{.QUEUE_DLQ_NAME | default (print .QUEUE_NAME "-dlq")}}'
    cmds:
      - cmd: |
          yes n | wrangler queues create "{{.QUEUE_NAME}}" || echo "Queue {{.QUEUE_NAME}} may already exist"
          yes n | wrangler queues create "{{.QUEUE_DLQ_NAME}}" || echo "DLQ {{.QUEUE_DLQ_NAME}} may already exist"

  queue:http-enable:*:
    desc: Ensure HTTP pull consumer is configured on a queue
    vars:
      NAME: "{{index .MATCH 0}}"
      QUEUE_NAME: '{{.QUEUE_NAME | default (print .CANOPY_ID "-" .NAME)}}'
    cmds:
      - cmd: |
          yes n | wrangler queues consumer http add "{{.QUEUE_NAME}}" || echo "HTTP pull already configured for {{.QUEUE_NAME}}"

  queue:inspect:*:
    desc: Show queue configuration (including consumer type)
    vars:
      NAME: "{{index .MATCH 0}}"
      QUEUE_NAME: '{{.QUEUE_NAME | default (print .CANOPY_ID "-" .NAME)}}'
    cmds:
      - cmd: |
          set -a
          [ -f .env ] && source .env
          [ -f .env.secrets ] && source .env.secrets
          set +a
          if [ -z "${CLOUDFLARE_API_TOKEN:-}" ]; then
            echo "ERROR: CLOUDFLARE_API_TOKEN is not set. Populate it in .env/.env.secrets."
            exit 1
          fi
          if ! command -v jq >/dev/null 2>&1; then
            echo "jq is required for queue:inspect:*" >&2
            exit 1
          fi
          RESPONSE=$(curl -fsS \
            -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
            "https://api.cloudflare.com/client/v4/accounts/{{.CLOUDFLARE_ACCOUNT_ID}}/queues/{{.QUEUE_NAME}}") || exit 1
          echo "$RESPONSE" | jq .

  queue:delete:*:
    desc: Delete a Cloudflare queue and its dead-letter queue (DESTRUCTIVE!)
    vars:
      NAME: "{{index .MATCH 0}}"
      QUEUE_NAME: '{{.QUEUE_NAME | default (print .CANOPY_ID "-" .NAME)}}'
      QUEUE_DLQ_NAME: '{{.QUEUE_DLQ_NAME | default (print .QUEUE_NAME "-dlq")}}'
    cmds:
      - cmd: |
          yes n | wrangler queues delete "{{.QUEUE_NAME}}"
          yes n | wrangler queues delete "{{.QUEUE_DLQ_NAME}}"

  r2notification:create:*:
    desc: Create R2 event notification to queue
    vars:
      NAME: "{{index .MATCH 0}}"
      QUEUE_NAME: '{{.QUEUE_NAME | default (print .CANOPY_ID "-" .NAME)}}'
      PREFIX: "{{.PREFIX}}"
      R2_BUCKET_NAME: "{{.R2_BUCKET_NAME}}"
    requires:
      vars: [R2_BUCKET_NAME]
    cmds:
      - cmd: |
          if [ -z "{{.PREFIX}}" ]; then
            echo "PREFIX must be set for r2notification:create:*" >&2
            exit 1
          fi
          yes n | wrangler r2 bucket notification create "{{.R2_BUCKET_NAME}}" \
            --event-type object-create \
            --queue "{{.QUEUE_NAME}}" \
            --prefix "{{.PREFIX}}" || echo "Notification may already be configured"

  r2notification:delete:*:
    desc: Delete R2 event notifications
    vars:
      NAME: "{{index .MATCH 0}}"
      QUEUE_NAME: '{{.QUEUE_NAME | default (print .CANOPY_ID "-" .NAME)}}'
      R2_BUCKET_NAME: "{{.R2_BUCKET_NAME}}"
    requires:
      vars: [R2_BUCKET_NAME]
    cmds:
      - cmd: |
          yes n | wrangler r2 bucket notification list "{{.R2_BUCKET_NAME}}" | grep -q "logs/" && \
            yes n | wrangler r2 bucket notification delete "{{.R2_BUCKET_NAME}}" --queue "{{.QUEUE_NAME}}" || \
            echo "No notifications to delete"
