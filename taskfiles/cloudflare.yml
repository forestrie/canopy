---
# Cloudflare infrastructure management using Wrangler

version: "3"

vars:
  CANOPY_ID: '{{.CANOPY_ID | default "canopy-dev-1"}}'
  R2_BUCKET_NAME: '{{.R2_BUCKET_NAME | default (print .CANOPY_ID "-leaves")}}'
  QUEUE_NAME: '{{.QUEUE_NAME | default (print .CANOPY_ID "-ranger")}}'
  QUEUE_DLQ_NAME: '{{.QUEUE_DLQ_NAME | default (print .QUEUE_NAME "-dlq")}}'

tasks:
  tools-check:
    desc: Check for required tools
    cmds:
      - cmd: |
          if ! command -v wrangler &> /dev/null; then
            echo "ERROR: wrangler not found. Install with 'pnpm add -g wrangler'"
            exit 1
          fi

  validate:
    desc: Validate Wrangler is installed and authenticated
    deps: [tools-check]
    cmds:
      - cmd: |
          if ! wrangler whoami &> /dev/null; then
            echo "ERROR: Wrangler is not authenticated. Run: wrangler login"
            exit 1
          fi

  bootstrap:
    desc: Create all Cloudflare resources (R2 buckets, queues, and event notifications)
    deps: [validate]
    cmds:
      - cmd: |
          echo "Creating Cloudflare infrastructure..."
          wrangler r2 bucket create "{{.R2_BUCKET_NAME}}" --location weur 2>/dev/null || true
          wrangler queues create "{{.QUEUE_NAME}}" 2>/dev/null || true
          wrangler queues create "{{.QUEUE_DLQ_NAME}}" 2>/dev/null || true
          echo "Configuring R2 event notifications..."
          wrangler r2 bucket notification create "{{.R2_BUCKET_NAME}}" \
            --event-type object-create \
            --queue "{{.QUEUE_NAME}}" \
            --prefix "logs/" \
            2>/dev/null || echo "Note: Notification may already be configured"
          echo "Infrastructure ready"

  apply:
    desc: Alias for bootstrap
    deps: [bootstrap]

  status:
    desc: Show status of all Cloudflare resources
    deps: [validate]
    cmds:
      - cmd: |
          echo "R2 Buckets:"
          wrangler r2 bucket list
      - cmd: |
          echo "Queues:"
          wrangler queues list
      - cmd: |
          echo "R2 Event Notifications for {{.R2_BUCKET_NAME}}:"
          wrangler r2 bucket notification list "{{.R2_BUCKET_NAME}}" 2>/dev/null || echo "  No notifications configured"

  destroy:
    desc: Delete all Cloudflare resources (DESTRUCTIVE!)
    deps: [validate]
    cmds:
      - cmd: |
          wrangler r2 bucket delete "{{.R2_BUCKET_NAME}}" 2>/dev/null || echo "Note: Bucket must be empty to delete"
          echo "Destruction complete"
