version: '3'

vars:
  CANOPY_DIR: './packages/apps/canopy'
  CANOPY_ID: '{{.CANOPY_ID}}'
  FOREST_PROJECT_ID: '{{.FOREST_PROJECT_ID}}'

tasks:
  all:
    desc: Build all packages in the monorepo
    cmds:
      - echo "ğŸ”¨ Building all packages..."
      - pnpm run build
      - echo "âœ… Build complete!"

  canopy:
    desc: Build SvelteKit app for Cloudflare Workers
    dir: '{{.CANOPY_DIR}}'
    cmds:
      - echo "ğŸ—ï¸  Building Canopy app for Cloudflare Workers..."
      - pnpm run build
      - echo "âœ… Canopy build complete!"

  shared:
    desc: Build shared packages (cbor, scitt, mmr utils)
    cmds:
      - echo "ğŸ“¦ Building shared packages..."
      - pnpm --filter "./packages/shared/*" run build
      - echo "âœ… Shared packages built!"

  clean:
    desc: Clean all build artifacts
    cmds:
      - echo "ğŸ§¹ Cleaning build artifacts..."
      - rm -rf packages/apps/canopy/.svelte-kit
      - rm -rf packages/apps/canopy/build
      - rm -rf packages/shared/*/dist
      - rm -rf packages/shared/*/build
      - echo "âœ… Clean complete!"

  watch:
    desc: Build and watch for changes
    cmds:
      - echo "ğŸ‘€ Starting build watch mode..."
      - pnpm run build --watch

  check:
    desc: Type-check all TypeScript code
    cmds:
      - echo "ğŸ” Type-checking TypeScript..."
      - pnpm -r run check
      - echo "âœ… Type check complete!"

  lint:
    desc: Lint and format check all code
    cmds:
      - echo "ğŸ¨ Linting code..."
      - pnpm run lint
      - pnpm run check
      - echo "âœ… Linting complete!"

  preview:
    desc: Preview production build locally
    dir: '{{.CANOPY_DIR}}'
    deps: [canopy]
    cmds:
      - echo "ğŸš€ Starting preview server..."
      - pnpm run preview

  vercel:
    desc: Simulate Vercel build process locally
    dir: '{{.CANOPY_DIR}}'
    env:
      VERCEL: '1'
      VERCEL_ENV: 'production'
      CANOPY_ID: '{{.CANOPY_ID}}'
      FOREST_PROJECT_ID: '{{.FOREST_PROJECT_ID}}'
    cmds:
      - echo "ğŸ”º Building with Vercel configuration..."
      - 'echo "  CANOPY_ID: {{.CANOPY_ID}}"'
      - 'echo "  FOREST_PROJECT_ID: {{.FOREST_PROJECT_ID}}"'
      - pnpm run build
      - echo "âœ… Vercel build simulation complete!"