---
# curl examples that excercise the scrapi endpoints

version: "3"

vars:
  BASE_URL: "{{.BASE_URL}}" # wrangler
  API_KEY: "test-api-key"

tasks:
  create-statement:hello:
    desc: Generate a hello world COSE Sign1 statement
    cmds:
      - node scripts/gen-cose-sign1.mjs

  create-statement:*:
    desc: Generate a COSE Sign1 statement with custom message
    vars:
      MESSAGE: "{{index .MATCH 0}}"
    cmds:
      - node scripts/gen-cose-sign1.mjs "{{.MESSAGE}}"

  decode-receipt:*:
    desc: Decode a CBOR receipt file and display in CDDL notation
    vars:
      RECEIPT: "{{index .MATCH 0}}"
    cmds:
      - node scripts/decode-receipt.mjs "{{.RECEIPT}}"

  register-statement:*:
    desc: Create, register, and resolve a COSE Sign1 statement to receipt
    silent: true
    vars:
      MESSAGE: "{{index .MATCH 0}}"
      MAX_POLLS: '{{.MAX_POLLS | default "30"}}'
      O: '{{.O | default "receipt.cbor"}}'
    cmds:
      - cmd: |
          set -euo pipefail

          # Generate statement
          STATEMENT=$(task -s -t "{{.ROOT_TASKFILE}}" "scrapi:create-statement:{{.MESSAGE}}")

          START_UTC=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # POST /entries
          post_headers=$(mktemp)
          post_body=$(mktemp)
          trap 'rm -f "$post_headers" "$post_body"' EXIT

          post_code=$(printf '%s' "$STATEMENT" \
            | curl -sS -D "$post_headers" -w "%{http_code}" -X POST "{{.BASE_URL}}/entries" \
              -H 'Content-Type: application/cose; cose-type="cose-sign1"' \
              -H "Authorization: Bearer {{.API_KEY}}" \
              --output "$post_body" \
              --data-binary @-)

          if [ "$post_code" -ge 400 ]; then
            echo "POST /entries failed with $post_code" >&2
            node scripts/decode-problem-details.mjs < "$post_body" >&2
            exit 1
          fi

          post_location=$(grep -i '^location:' "$post_headers" | awk '{print $2}' | tr -d '\r')

          if [ "$post_code" != "303" ] || [ -z "$post_location" ]; then
            echo "Unexpected POST response: code=$post_code location=$post_location" >&2
            exit 1
          fi

          status_url="$post_location"

          # Poll for receipt
          receipt_url=""
          for attempt in $(seq 1 {{.MAX_POLLS}}); do
            poll_headers=$(mktemp)
            poll_body=$(mktemp)

            poll_code=$(curl -sS -D "$poll_headers" -w "%{http_code}" -X GET "$status_url" \
              -H "Authorization: Bearer {{.API_KEY}}" \
              --output "$poll_body")

            if [ "$poll_code" -ge 400 ]; then
              echo "Poll failed with $poll_code" >&2
              node scripts/decode-problem-details.mjs < "$poll_body" >&2
              rm -f "$poll_headers" "$poll_body"
              exit 1
            fi

            poll_location=$(grep -i '^location:' "$poll_headers" | awk '{print $2}' | tr -d '\r')
            rm -f "$poll_headers" "$poll_body"

            if echo "$poll_location" | grep -q '/receipt$'; then
              receipt_url="$poll_location"
              break
            fi

            sleep 1
          done

          if [ -z "$receipt_url" ]; then
            echo "Timed out after {{.MAX_POLLS}} polls (started $START_UTC)" >&2
            exit 1
          fi

          # GET receipt
          receipt_body=$(mktemp)
          receipt_code=$(curl -sS -w "%{http_code}" -X GET "$receipt_url" \
            -H "Authorization: Bearer {{.API_KEY}}" \
            -H 'Accept: application/scitt-receipt+cbor' \
            --output "$receipt_body")

          if [ "$receipt_code" -ge 400 ]; then
            echo "GET receipt failed with $receipt_code" >&2
            node scripts/decode-problem-details.mjs < "$receipt_body" >&2
            rm -f "$receipt_body"
            exit 1
          fi

          mv "$receipt_body" "{{.O}}"
          echo "$(cd "$(dirname "{{.O}}")" && pwd)/$(basename "{{.O}}")"

  trapper:*:
    desc: Batch POST N statements then poll for receipts, reporting latency
    silent: true
    vars:
      COUNT: "{{index .MATCH 0}}"
      MAX_POLLS: '{{.MAX_POLLS | default "60"}}'
    cmds:
      - cmd: |
          set -euo pipefail

          count="{{.COUNT}}"
          if ! [[ "$count" =~ ^[0-9]+$ ]] || [ "$count" -lt 1 ]; then
            echo "Usage: task scrapi:trapper:<count>" >&2
            echo "  count must be a positive integer" >&2
            exit 1
          fi

          echo "Generating $count statements..."
          statements=()
          for i in $(seq 1 "$count"); do
            statements+=("$(task -s -t "{{.ROOT_TASKFILE}}" "scrapi:create-statement:trapper-$i-$(date +%s)" 2>/dev/null)")
          done
          echo "Generated $count statements"

          echo "POSTing $count statements..."
          status_urls=()
          start_times=()
          for i in $(seq 1 "$count"); do
            idx=$((i - 1))
            start_ns=$(python3 -c 'import time; print(int(time.time_ns()))')
            start_times+=("$start_ns")

            post_headers=$(mktemp)
            post_body=$(mktemp)

            post_code=$(printf '%s' "${statements[$idx]}" \
              | curl -sS -D "$post_headers" -w "%{http_code}" -X POST "{{.BASE_URL}}/entries" \
                -H 'Content-Type: application/cose; cose-type="cose-sign1"' \
                -H "Authorization: Bearer {{.API_KEY}}" \
                --output "$post_body" \
                --data-binary @-)

            if [ "$post_code" -ge 400 ]; then
              echo "POST $i failed with $post_code" >&2
              status_urls+=("") 
              rm -f "$post_headers" "$post_body"
              continue
            fi

            status_url=$(grep -i '^location:' "$post_headers" | awk '{print $2}' | tr -d '\r')
            status_urls+=("$status_url")
            rm -f "$post_headers" "$post_body"
          done
          echo "POSTed $count statements"
          echo "---"

          # Poll for all receipts
          receipt_urls=()
          for i in $(seq 1 "$count"); do
            receipt_urls+=("") 
          done

          pending=$count
          for attempt in $(seq 1 {{.MAX_POLLS}}); do
            if [ $pending -eq 0 ]; then
              break
            fi

            for i in $(seq 1 "$count"); do
              idx=$((i - 1))
              # Skip if already got receipt or no status URL
              if [ -n "${receipt_urls[$idx]}" ] || [ -z "${status_urls[$idx]}" ]; then
                continue
              fi

              poll_headers=$(mktemp)
              poll_body=$(mktemp)

              poll_code=$(curl -sS -D "$poll_headers" -w "%{http_code}" -X GET "${status_urls[$idx]}" \
                -H "Authorization: Bearer {{.API_KEY}}" \
                --output "$poll_body" 2>/dev/null)

              poll_location=$(grep -i '^location:' "$poll_headers" | awk '{print $2}' | tr -d '\r')
              rm -f "$poll_headers" "$poll_body"

              if echo "$poll_location" | grep -q '/receipt$'; then
                receipt_urls[$idx]="$poll_location"
                end_ns=$(python3 -c 'import time; print(int(time.time_ns()))')
                latency_ms=$(( (end_ns - ${start_times[$idx]}) / 1000000 ))
                printf "Statement %2d: %5d ms\n" "$i" "$latency_ms"
                pending=$((pending - 1))
              fi
            done

            if [ $pending -gt 0 ]; then
              sleep 0.5
            fi
          done

          echo "---"
          if [ $pending -gt 0 ]; then
            echo "WARNING: $pending statements did not receive receipts"
          fi
          echo "Completed $((count - pending)) of $count statements"

  post-entry:
    desc: Post a COSE Sign1 message with random UUID to the /entries endpoint
    cmds:
      - cmd: |
          http_code=$(node scripts/gen-cose-sign1.mjs \
          | curl -v -w "%{http_code}" -X POST "{{.BASE_URL}}/entries" \
          -H 'Content-Type: application/cose; cose-type="cose-sign1"' \
          -H "Authorization: Bearer {{.API_KEY}}" \
          --output post-entry-rand.response \
          --data-binary @-)

          if [ "$http_code" -ge 400 ]; then
            echo ""
            echo "Error response body (decoded):"
            node scripts/decode-problem-details.mjs < post-entry-rand.response
          fi
