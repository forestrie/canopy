name: Cloudflare Infrastructure

on:
  workflow_dispatch:
    inputs:
      action:
        description: "Infrastructure action"
        required: true
        default: "apply"
        type: choice
        options:
          - apply
          - destroy
          - status
      canopy_id:
        description: "Canopy Instance ID"
        required: true
        default: "canopy-dev-1"
      forest_project_id:
        description: "Forest Project ID (external reference)"
        required: true
        default: "forest-dev-1"

jobs:
  wrangler:
    name: Wrangler ${{ inputs.action }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install go-task
        uses: arduino/setup-task@v2
        with:
          version: 3.x
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9.6.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.14.0
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install

      - name: Install Wrangler
        run: pnpm add -g wrangler

      - name: Authenticate Wrangler
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          echo "Authenticating with Cloudflare..."
          yes n | wrangler whoami

      - name: Apply Infrastructure
        if: inputs.action == 'apply'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CANOPY_ID: ${{ inputs.canopy_id }}
          R2_BUCKET_NAME: ${{ inputs.canopy_id }}-leaves
          QUEUE_NAME: ${{ inputs.canopy_id }}-ranger
          QUEUE_DLQ_NAME: ${{ inputs.canopy_id }}-ranger-dlq
        run: |
          echo "Creating Cloudflare infrastructure with Wrangler..."
          echo "CANOPY_ID: ${CANOPY_ID}"
          echo "R2_BUCKET_NAME: ${R2_BUCKET_NAME}"
          echo "QUEUE_NAME: ${QUEUE_NAME}"
          echo "QUEUE_DLQ_NAME: ${QUEUE_DLQ_NAME}"
          task cf:bootstrap
      - name: Configure R2 CORS
        if: inputs.action == 'apply'
        env:
          R2_ADMIN: ${{ secrets.R2_ADMIN }}
          CLOUDFLARE_ACCOUNT_ID: "68f25af297c4235c3f1c47b2f73925b0"
          R2_BUCKET_NAME: ${{ inputs.canopy_id }}-leaves
        run: |
          echo "Configuring CORS for R2 bucket ${R2_BUCKET_NAME}"

          cat > cors.json <<'EOF'
          {
            "rules": [
              {
                "allowed": {
                  "origins": [
                    "http://localhost:5173",
                    "http://localhost:3000",
                    "https://canopy.vercel.app",
                    "https://canopy.dev-1.forestrie.dev",
                    "https://scrapi.dev-1.forestrie.dev"
                  ],
                  "methods": ["GET", "HEAD", "POST", "PUT"],
                  "headers": ["*"]
                },
                "exposeHeaders": ["ETag", "Content-Type", "Content-Length"],
                "maxAgeSeconds": 3600
              }
            ]
          }
          EOF

          if ! jq . cors.json >/dev/null 2>&1; then
            echo "cors.json is not valid JSON"
            cat cors.json
            exit 1
          fi
          echo "Configuring CORS for R2 bucket ${R2_BUCKET_NAME}"

              # --- Apply policy ---
          APPLY_RESPONSE=$(curl -sS -X PUT \
            "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/r2/buckets/${R2_BUCKET_NAME}/cors" \
            -H "Authorization: Bearer ${R2_ADMIN}" \
            -H "Content-Type: application/json" \
            --data-binary @cors.json \
            --fail-with-body
          ) || {
            echo $APPLY_RESPONSE
            echo "Failed to configure CORS (PUT request failed)"
            exit 1
          }

          # Optional debug
          echo "RESPONSE: ${APPLY_RESPONSE}"

      - name: Show Status
        if: inputs.action == 'status'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          R2_BUCKET_NAME: ${{ inputs.canopy_id }}-leaves
          QUEUE_NAME: ${{ inputs.canopy_id }}-ranger
        run: |
          echo "Cloudflare Infrastructure Status"
          task cf:status

      - name: Destroy Infrastructure
        if: inputs.action == 'destroy'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CANOPY_ID: ${{ inputs.canopy_id }}
          R2_BUCKET_NAME: ${{ inputs.canopy_id }}-leaves
          QUEUE_NAME: ${{ inputs.canopy_id }}-ranger
          QUEUE_DLQ_NAME: ${{ inputs.canopy_id }}-ranger-dlq
        run: |
          echo "Destroying Cloudflare infrastructure..."
          echo "CANOPY_ID: ${CANOPY_ID}"
          echo "R2_BUCKET_NAME: ${R2_BUCKET_NAME}"
          echo "QUEUE_NAME: ${QUEUE_NAME}"
          echo "QUEUE_DLQ_NAME: ${QUEUE_DLQ_NAME}"
          task cf:destroy
