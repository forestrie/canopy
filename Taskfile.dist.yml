version: "3"

dotenv: [".env", ".env.secrets"]

includes:
  scrapi:
    taskfile: ./taskfiles/scrapi.yml
    vars:
      BASE_URL: https://canopy-api.robinbryce.workers.dev/logs/3062ea57-c184-41d8-bd61-296b02c680d8
  scout:
    taskfile: ./taskfiles/scout.yml
    vars:
      BASE_URL: https://scout.dev-1.forestrie.dev
  cf: ./taskfiles/cloudflare.yml
  minio: ./taskfiles/minio.yml
  wrangler: ./taskfiles/wrangler.yml
  merklelog: ./taskfiles/merklelog.yml

vars:
  CANOPY_ID: '{{.CANOPY_ID | default "canopy-dev-1"}}'
  FOREST_PROJECT_ID: '{{.FOREST_PROJECT_ID | default "forest-dev-1"}}'
  CLOUDFLARE_ACCOUNT_ID: "{{.CLOUDFLARE_ACCOUNT_ID}}"

tasks:
  default:
    desc: Show available tasks
    cmds:
      - task --list

  test:
    desc: run all the current tests
    cmds:
      - pnpm -r test
  build:
    desc: build everything
    cmds:
      - pnpm -r build

  tools:check:
    desc: Check for required tools (Node, pnpm, Wrangler)
    cmds:
      - |
        MISSING_TOOLS=""

        # Check Node.js
        if ! command -v node &> /dev/null; then
          MISSING_TOOLS="${MISSING_TOOLS}  Node.js: Install from https://nodejs.org/\n"
        fi

        # Check pnpm
        if ! command -v pnpm &> /dev/null; then
          MISSING_TOOLS="${MISSING_TOOLS}  pnpm: Install with 'npm install -g pnpm' or from https://pnpm.io/\n"
        fi

        # Check Wrangler (Cloudflare CLI)
        if ! command -v wrangler &> /dev/null; then
          MISSING_TOOLS="${MISSING_TOOLS}  Wrangler: Install with 'pnpm add -g wrangler'\n"
        fi

        # Check Playwright (for e2e tests)
        if ! npx playwright --version &> /dev/null 2>&1; then
          MISSING_TOOLS="${MISSING_TOOLS}  Playwright: Will be installed with 'pnpm install'\n"
        fi

        if [ -n "$MISSING_TOOLS" ]; then
          echo "Missing tools detected:"
          echo -e "$MISSING_TOOLS"
          echo "Please install the missing tools before proceeding."
          exit 1
        fi
