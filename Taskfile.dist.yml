version: "3"

dotenv: [".env", ".env.secrets"]

includes:
  scrapi: ./taskfiles/scrapi.yml
  cf: ./taskfiles/cloudflare.yml
  minio: ./taskfiles/minio.yml
  wrangler: ./taskfiles/wrangler.yml

vars:
  CANOPY_ID: '{{.CANOPY_ID | default "canopy-dev-1"}}'
  FOREST_PROJECT_ID: '{{.FOREST_PROJECT_ID | default "forest-dev-1"}}'
  CLOUDFLARE_ACCOUNT_ID: "{{.CLOUDFLARE_ACCOUNT_ID}}"

tasks:
  default:
    desc: Show available tasks
    cmds:
      - task --list

  test:
    desc: run all the current tests
    cmds:
      - |
        cd packages/apps/canopy
        pnpm test:unit
        pnpm test:scrapi
        pnpm test:compliance

  tools:check:
    desc: Check for required tools (Node, pnpm, Wrangler)
    cmds:
      - |
        MISSING_TOOLS=""

        # Check Node.js
        if ! command -v node &> /dev/null; then
          MISSING_TOOLS="${MISSING_TOOLS}  Node.js: Install from https://nodejs.org/\n"
        fi

        # Check pnpm
        if ! command -v pnpm &> /dev/null; then
          MISSING_TOOLS="${MISSING_TOOLS}  pnpm: Install with 'npm install -g pnpm' or from https://pnpm.io/\n"
        fi

        # Check Wrangler (Cloudflare CLI)
        if ! command -v wrangler &> /dev/null; then
          MISSING_TOOLS="${MISSING_TOOLS}  Wrangler: Install with 'pnpm add -g wrangler'\n"
        fi

        # Check Playwright (for e2e tests)
        if ! npx playwright --version &> /dev/null 2>&1; then
          MISSING_TOOLS="${MISSING_TOOLS}  Playwright: Will be installed with 'pnpm install'\n"
        fi

        if [ -n "$MISSING_TOOLS" ]; then
          echo "Missing tools detected:"
          echo -e "$MISSING_TOOLS"
          echo "Please install the missing tools before proceeding."
          exit 1
        fi
